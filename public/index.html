<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>QR Вход - Компьютер</title>
</head>
<body>
  <h1>Сканируйте QR код с телефона</h1>
  <div id="qr"></div>
  <div id="status"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    async function generateQR() {
      const res = await fetch('/qr');
      const data = await res.json();
      const qrDiv = document.getElementById('qr');
      const statusDiv = document.getElementById('status');

      // Генерируем QR код с URL
      QRCode.toCanvas(data.url, { width: 200 }, (error, canvas) => {
        if (error) console.error(error);
        qrDiv.appendChild(canvas);
      });

      statusDiv.textContent = 'Ожидание авторизации...';

      // Подключаем webSocket с sessionId
      const ws = new WebSocket(`ws://${location.host}`);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'register', sessionId: data.sessionId }));
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'authorized') {
          statusDiv.textContent = 'Пользователь вошёл! Запуск приложения...';
          // Здесь можно запустить приложение или показать интерфейс
        }
      };

      ws.onclose = () => {
        statusDiv.textContent = 'Соединение закрыто.';
      };
    }

    generateQR();
  </script>
</body>
</html>
