<!DOCTYPE html>
<html>
<head>
  <title>–û–Ω–ª–∞–π–Ω-—á–∞—Ç —Å —Ñ–æ—Ç–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</title>
  <style>
    body { margin: 0; padding-bottom: 3rem; font-family: sans-serif; }
    #messages { list-style-type: none; margin: 0; padding: 0; }
    #messages li { padding: 0.5rem 1rem; border-bottom: 1px solid #eee; }
    #messages li:nth-child(odd) { background: #efefef; }
    #form { background: #000; padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; }
    #input { border: none; padding: 0 1rem; flex-grow: 1; margin: 0.25rem; border-radius: 2rem; }
    #input:focus { outline: none; }
    #form button, #form label { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 2rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    #file-input { display: none; } 
    .message-content img { max-width: 250px; height: auto; border-radius: 5px; display: block; margin-top: 5px; }
    .photo-message { background-color: #f0fff0; }
    .timestamp { font-size: 0.75rem; color: #888; margin-right: 10px; }
  </style>
</head>
<body>
  <ul id="messages"></ul>
  <form id="form">
    <label for="file-input" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">
        üì∑
        <input type="file" id="file-input" accept="image/*">
    </label>
    <input id="input" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    const fileInput = document.getElementById('file-input');
    
    function scrollToBottom() {
      window.scrollTo(0, document.body.scrollHeight);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ)
    function displayMessage(msg) {
      const item = document.createElement('li');
      const timeSpan = `<span class="timestamp">${msg.timestamp}</span>`;
      let content = '';
      
      if (msg.type === 'text') {
        content = `${msg.text}`;
      } else if (msg.type === 'photo') {
        // –°–æ–∑–¥–∞–µ–º —Ç–µ–≥ <img> —Å URL, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª —Å–µ—Ä–≤–µ—Ä
        content = `
          ${msg.text}
          <div class="message-content">
              <img src="${msg.url}" alt="–§–æ—Ç–æ –æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞">
          </div>
        `;
        item.classList.add('photo-message');
      }

      item.innerHTML = timeSpan + content;
      messages.appendChild(item);
      scrollToBottom();
    }

    // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (input.value.trim()) {
        socket.emit('chat message', input.value.trim());
        input.value = '';
      }
    });

    // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ (–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ HTTP POST)
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
             alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
             return;
        }

        const formData = new FormData();
        // 'photo' –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—è –≤ `upload.single('photo')` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        formData.append('photo', file);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.');
            }
            // –°–µ—Ä–≤–µ—Ä —Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º —á–µ—Ä–µ–∑ Socket.IO –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ.');
        } finally {
            // –û—á–∏—Å—Ç–∫–∞ input
            fileInput.value = '';
        }
    });

    // 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
    socket.on('history', (history) => {
        messages.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏
        history.forEach(msg => displayMessage(msg));
    });

    // 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–≤–∫–ª—é—á–∞—è —Ñ–æ—Ç–æ)
    socket.on('chat message', (msg) => {
      displayMessage(msg);
    });
  </script>
</body>
</html>